<?php

/**
 * @file
 * Project Health report from Drupal.org .
 */

/**
 * Implements hook_form_alter().
 */
function projecthealth_form_project_node_form_alter(&$form, &$form_state) {
  $form['title'] = array(
    '#value' => t('Project details not available yet.'),
  );
  $form['body']['#access'] = FALSE;
}

/**
 * Implements hook_menu().
 */
function projecthealth_menu() {

  $items['projecthealth/add'] = array(
    'title' => 'Take snapshot of a project',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('projecthealth_form'),
    'access arguments' => array('projecthealth take snapshot'),
    'type' => MENU_SUGGESTED_ITEM,
  );

  return $items;
}

/**
 * Form to create snapshot of a project.
 *
 * @see projecthealth_menu()
 */
function projecthealth_form($form, &$form_state) {

  // @todo: support monthly snapshot.
  $form['snapshot'] = array(
    '#type' => 'textfield',
    '#title' => t('Snapshot name'),
    '#description' => t('Give the name to snapshot.'),
    '#default_value' => t('All time'),
    '#disabled' => TRUE,
  );

  $form['field_project_machine_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Project machine name'),
    '#description' => t('The machine name of the project at Drupal.org'),
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Create'),
  );
  return $form;
}

/**
 * Submit handler for projecthealth_form().
 */
function projecthealth_form_submit($form, $form_state) {
  $values = $form_state['values'];
  dpm($values);
}

/**
 * Implements hook_permission().
 */
function projecthealth_permission() {
  return array(
    'projecthealth take snapshot' => array(
      'title' => t('Create Project health snapshot'),
      'description' => t('Take a project health snapshot'),
    ),
  );
}

/**
 * Implements hook_cron_queue_info().
 */
function projecthealth_cron_queue_info() {
  $queues['projecthealth_issues'] = array(
    'worker callback' => 'projecthealth_snapshot_process_issues',
    'time' => 30,
  );
  $queues['projecthealth_comments'] = array(
    'worker callback' => 'projecthealth_snapshot_process_comments',
    'time' => 30,
  );
  return $queues;
}

